<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InventoryService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Restaurant Management System</a> &gt; <a href="index.source.html" class="el_package">com.university.restaurant.service</a> &gt; <span class="el_source">InventoryService.java</span></div><h1>InventoryService.java</h1><pre class="source lang-java linenums">package com.university.restaurant.service;

import com.university.restaurant.chain.inventory.InventoryPermissionChain;
import com.university.restaurant.model.inventory.InventoryItem;
import com.university.restaurant.model.staff.StaffRole;
import com.university.restaurant.port.InventoryServicePort;
import com.university.restaurant.repository.InventoryRepository;
import com.university.restaurant.repository.MenuRepository;
import com.university.restaurant.repository.RestaurantAuditEntry;
import com.university.restaurant.repository.RestaurantAuditLogRepository;

/**
 * &lt;p&gt;
 * Service implementation for inventory-related operations such as reducing or
 * increasing stock levels and querying current inventory state. This class
 * enforces business rules, interacts with repositories, and ensures that
 * menu item availability is synchronized with stock levels.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * Role-based authorization is handled through the
 * {@link InventoryPermissionChain}, which determines whether a given
 * {@link StaffRole} has permission to perform inventory operations.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * All mutations to inventory are logged using {@link RestaurantAuditLogRepository}
 * to provide a tamper-evident audit trail.
 * &lt;/p&gt;
 */
public class InventoryService implements InventoryServicePort {

    /** Repository providing access to persisted inventory items. */
    private final InventoryRepository repo;

    /** Repository containing menu items affected by inventory changes. */
    private final MenuRepository menuRepo;

    /** Audit log repository used to track inventory actions. */
    private final RestaurantAuditLogRepository audits;

    /** Permission chain used to validate actor roles for inventory operations. */
<span class="fc" id="L43">    private final InventoryPermissionChain permissions = new InventoryPermissionChain();</span>

    /**
     * Constructs the inventory service with the required repositories and audit log.
     *
     * @param r        the inventory repository
     * @param menuRepo the menu repository for updating item availability
     * @param a        the audit log repository
     */
<span class="fc" id="L52">    public InventoryService(InventoryRepository r, MenuRepository menuRepo, RestaurantAuditLogRepository a) {</span>
<span class="fc" id="L53">        this.repo = r;</span>
<span class="fc" id="L54">        this.menuRepo = menuRepo;</span>
<span class="fc" id="L55">        this.audits = a;</span>
<span class="fc" id="L56">    }</span>

    /**
     * &lt;p&gt;
     * Reduces the stock level of a specific inventory item. If the stock reaches zero,
     * the corresponding menu item (if present) is marked unavailable.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * Steps performed:
     * &lt;/p&gt;
     * &lt;ol&gt;
     *     &lt;li&gt;Verify actor permissions.&lt;/li&gt;
     *     &lt;li&gt;Load the inventory item or throw if not found.&lt;/li&gt;
     *     &lt;li&gt;Consume the specified quantity (with domain rules enforced).&lt;/li&gt;
     *     &lt;li&gt;Persist the updated item.&lt;/li&gt;
     *     &lt;li&gt;If stock reaches zero, update the related menu item's availability.&lt;/li&gt;
     *     &lt;li&gt;Record an audit log entry.&lt;/li&gt;
     * &lt;/ol&gt;
     *
     * @param actor  the staff role performing the action
     * @param itemId the ID of the inventory item
     * @param qty    the quantity to reduce
     *
     * @throws SecurityException        if the actor lacks permission
     * @throws IllegalArgumentException if the item does not exist
     * @throws IllegalStateException    if the reduction violates stock constraints
     */
    @Override
    public void reduceStock(StaffRole actor, String itemId, int qty) {

<span class="fc" id="L87">        permissions.check(actor, &quot;reduce stock&quot;);</span>

<span class="fc" id="L89">        InventoryItem item = repo.findById(itemId)</span>
<span class="pc" id="L90">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Item not found: &quot; + itemId));</span>

        // Reduce stock
<span class="fc" id="L93">        item.consume(qty);</span>

        // Save updated item
<span class="fc" id="L96">        repo.save(item);</span>

        // If stock hits zero â†’ mark MenuItem unavailable
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (item.getStockLevel() == 0) {</span>
<span class="fc" id="L100">            menuRepo.findById(itemId).ifPresent(menuItem -&gt; {</span>
<span class="fc" id="L101">                menuItem.setAvailable(false);</span>
<span class="fc" id="L102">                menuRepo.save(menuItem);</span>
<span class="fc" id="L103">            });</span>
        }

        // Audit
<span class="fc" id="L107">        audits.append(new RestaurantAuditEntry(</span>
<span class="fc" id="L108">                actor.id(),</span>
<span class="fc" id="L109">                actor.getClass().getSimpleName(),</span>
                &quot;REDUCE_STOCK&quot;,
                &quot;InventoryItem&quot;,
                itemId,
                &quot;Reduced stock by &quot; + qty,
<span class="fc" id="L114">                audits.tailHash()</span>
        ));
<span class="fc" id="L116">    }</span>

    /**
     * &lt;p&gt;
     * Increases the stock level of an inventory item. Capacity limits are enforced
     * by the domain logic within the {@link InventoryItem}. If stock becomes
     * positive, related menu items may be marked available again.
     * &lt;/p&gt;
     *
     * @param actor  the staff role performing the restock
     * @param itemId the ID of the inventory item
     * @param qty    the quantity to add
     *
     * @throws SecurityException        if actor lacks permission
     * @throws IllegalArgumentException if the item does not exist
     */
    @Override
    public void increaseStock(StaffRole actor, String itemId, int qty) {

<span class="fc" id="L135">        permissions.check(actor, &quot;increase stock&quot;);</span>

<span class="fc" id="L137">        InventoryItem item = repo.findById(itemId)</span>
<span class="pc" id="L138">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Item not found: &quot; + itemId));</span>

        // Domain rule: restock with capacity enforcement
<span class="fc" id="L141">        item.restock(qty);</span>

        // Save updated item
<span class="fc" id="L144">        repo.save(item);</span>

<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (item.getStockLevel() &gt; 0) {</span>
<span class="fc" id="L147">            menuRepo.findById(itemId).ifPresent(menuItem -&gt; {</span>
<span class="fc" id="L148">                menuItem.setAvailable(true);</span>
<span class="fc" id="L149">                menuRepo.save(menuItem);</span>
<span class="fc" id="L150">            });</span>
        }

        // Audit
<span class="fc" id="L154">        audits.append(new RestaurantAuditEntry(</span>
<span class="fc" id="L155">                actor.id(),</span>
<span class="fc" id="L156">                actor.getClass().getSimpleName(),</span>
                &quot;RESTOCK&quot;,
                &quot;InventoryItem&quot;,
                itemId,
                &quot;Restocked &quot; + qty + &quot; units&quot;,
<span class="fc" id="L161">                audits.tailHash()</span>
        ));

<span class="fc" id="L164">    }</span>

    /**
     * Retrieves the current stock level for a given inventory item.
     *
     * @param itemId the ID of the item to query
     * @return the current stock level
     *
     * @throws IllegalArgumentException if the item does not exist
     */
    @Override
    public int getStockLevel(String itemId) {
<span class="fc" id="L176">        InventoryItem item = repo.findById(itemId)</span>
<span class="fc" id="L177">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Item not found: &quot; + itemId));</span>

<span class="fc" id="L179">        return item.getStockLevel();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>