<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReservationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Restaurant Management System</a> &gt; <a href="index.source.html" class="el_package">com.university.restaurant.service</a> &gt; <span class="el_source">ReservationService.java</span></div><h1>ReservationService.java</h1><pre class="source lang-java linenums">package com.university.restaurant.service;

import com.university.restaurant.chain.reservation.ReservationPermissionChain;
import com.university.restaurant.model.reservation.Customer;
import com.university.restaurant.model.reservation.Reservation;
import com.university.restaurant.model.reservation.ReservationStatus;
import com.university.restaurant.model.staff.StaffRole;
import com.university.restaurant.port.ReservationServicePort;
import com.university.restaurant.repository.ReservationRepository;
import com.university.restaurant.repository.RestaurantAuditEntry;
import com.university.restaurant.repository.RestaurantAuditLogRepository;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * &lt;p&gt;
 * Concrete implementation of {@link ReservationServicePort}, responsible for
 * managing customer reservations within the restaurant system. This service
 * enforces role-based permissions, applies domain rules, persists reservation
 * state, and records audit entries for all reservation-related actions.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * Following Hexagonal Architecture principles, this class depends only on
 * repository interfaces and the permission chain rather than specific storage
 * or UI details. All business logic related to reservations is centralized here.
 * &lt;/p&gt;
 */
public class ReservationService implements ReservationServicePort {

    private final ReservationRepository repo;
    private final RestaurantAuditLogRepository audits;
<span class="fc" id="L34">    private final ReservationPermissionChain permissionChain = new ReservationPermissionChain();</span>

    /**
     * Constructs a new ReservationService with the required repositories.
     *
     * @param repo   the repository used to save and retrieve reservations
     * @param audits the repository responsible for appending audit log entries
     */
<span class="fc" id="L42">    public ReservationService(ReservationRepository repo, RestaurantAuditLogRepository audits) {</span>
<span class="fc" id="L43">        this.repo = repo;</span>
<span class="fc" id="L44">        this.audits = audits;</span>
<span class="fc" id="L45">    }</span>

    /**
     * {@inheritDoc}
     *
     * &lt;p&gt;This implementation performs the following steps:&lt;/p&gt;
     * &lt;ul&gt;
     *     &lt;li&gt;Validates that the actor has permission to create reservations&lt;/li&gt;
     *     &lt;li&gt;Builds a new {@link Customer} instance&lt;/li&gt;
     *     &lt;li&gt;Constructs a {@link Reservation} with the provided details&lt;/li&gt;
     *     &lt;li&gt;Saves the reservation to persistent storage&lt;/li&gt;
     *     &lt;li&gt;Writes an audit log entry describing the action&lt;/li&gt;
     * &lt;/ul&gt;
     */
    @Override
    public Reservation createReservation(StaffRole actor, String name, String phone, String email,
                                         int partySize, LocalDateTime time) {

<span class="fc" id="L63">        permissionChain.check(actor, &quot;create a reservation&quot;);</span>

<span class="fc" id="L65">        Customer customer = new Customer(name, phone, email);</span>

<span class="fc" id="L67">        Reservation reservation = new Reservation(customer, time, partySize);</span>

        // Save to repository
<span class="fc" id="L70">        repo.save(reservation);</span>

        // Audit creation
<span class="fc" id="L73">        audits.append(new RestaurantAuditEntry(</span>
<span class="fc" id="L74">                actor.id(),</span>
<span class="fc" id="L75">                actor.getClass().getSimpleName(),</span>
                &quot;CREATE_RESERVATION&quot;,
<span class="fc" id="L77">                customer.getName(),</span>
<span class="fc" id="L78">                reservation.getId().toString(),</span>
                &quot;PARTY_SIZE: &quot; + partySize,
<span class="fc" id="L80">                audits.tailHash()</span>
        ));

<span class="fc" id="L83">        return reservation;</span>
    }

    /**
     * {@inheritDoc}
     *
     * &lt;p&gt;
     * This method:
     * &lt;/p&gt;
     * &lt;ul&gt;
     *     &lt;li&gt;Checks permission for the actor&lt;/li&gt;
     *     &lt;li&gt;Attempts to retrieve the reservation&lt;/li&gt;
     *     &lt;li&gt;Returns {@code false} if it does not exist&lt;/li&gt;
     *     &lt;li&gt;Updates its status to {@link ReservationStatus#CANCELLED}&lt;/li&gt;
     *     &lt;li&gt;Saves the modified reservation&lt;/li&gt;
     *     &lt;li&gt;Records an audit log entry&lt;/li&gt;
     * &lt;/ul&gt;
     */
    @Override
    public boolean cancelReservation(StaffRole actor, String reservationId) {

<span class="fc" id="L104">        permissionChain.check(actor, &quot;cancel a reservation&quot;);</span>

<span class="fc" id="L106">        UUID id = UUID.fromString(reservationId);</span>

<span class="fc" id="L108">        Reservation reservation = repo.findById(id).orElse(null);</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (reservation == null) {</span>
<span class="fc" id="L111">            return false; // Nothing to cancel</span>
        }

        // Update reservation status
<span class="fc" id="L115">        reservation.updateStatus(ReservationStatus.CANCELLED);</span>

        // Save updated reservation
<span class="fc" id="L118">        repo.save(reservation);</span>

        // Audit cancellation
<span class="fc" id="L121">        audits.append(new RestaurantAuditEntry(</span>
<span class="fc" id="L122">                actor.id(),</span>
<span class="fc" id="L123">                actor.getClass().getSimpleName(),</span>
                &quot;CANCEL_RESERVATION&quot;,
                null,
<span class="fc" id="L126">                reservation.getId().toString(),</span>
<span class="fc" id="L127">                &quot;RESERVATION_TIME: &quot; + reservation.getReservationTime(),</span>
<span class="fc" id="L128">                audits.tailHash()</span>
        ));

<span class="fc" id="L131">        return true;</span>
    }

    /**
     * {@inheritDoc}
     *
     * &lt;p&gt;
     * Retrieves a reservation by its identifier, throwing an exception if no such
     * reservation exists.
     * &lt;/p&gt;
     */
    @Override
    public Reservation findReservation(String reservationId) {

<span class="fc" id="L145">        UUID id = UUID.fromString(reservationId);</span>

<span class="fc" id="L147">        return repo.findById(id)</span>
<span class="fc" id="L148">                .orElseThrow(() -&gt;</span>
<span class="fc" id="L149">                        new IllegalArgumentException(&quot;Reservation not found: &quot; + reservationId)</span>
                );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>