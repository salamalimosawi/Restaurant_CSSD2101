<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnalyticsService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Restaurant Management System</a> &gt; <a href="index.source.html" class="el_package">com.university.restaurant.service</a> &gt; <span class="el_source">AnalyticsService.java</span></div><h1>AnalyticsService.java</h1><pre class="source lang-java linenums">package com.university.restaurant.service;

import com.university.restaurant.chain.analytics.AnalyticsPermissionChain;
import com.university.restaurant.model.menu.MenuItem;
import com.university.restaurant.model.order.Order;
import com.university.restaurant.model.order.OrderStatus;
import com.university.restaurant.model.staff.StaffRole;
import com.university.restaurant.port.AnalyticsServicePort;
import com.university.restaurant.repository.OrderRepository;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * &lt;p&gt;
 * Service implementation for analytics-related operations such as computing
 * top-selling menu items and daily revenue totals. This class sits in the
 * application/service layer and interacts with the {@link OrderRepository}
 * to retrieve order data.
 * &lt;/p&gt;
 *
 * &lt;p&gt;
 * All analytics methods enforce role-based access control via
 * {@link AnalyticsPermissionChain} before performing computations.
 * Unauthorized roles must be blocked by throwing {@link SecurityException}.
 * &lt;/p&gt;
 */
public class AnalyticsService implements AnalyticsServicePort {

    /** Repository for retrieving order records used in analytics. */
    private final OrderRepository orders;

    /** Permission chain enforcing which staff roles may access analytics. */
<span class="fc" id="L37">    private final AnalyticsPermissionChain permissions = new AnalyticsPermissionChain();</span>

    /**
     * Constructs the analytics service with the required order repository.
     *
     * @param orders repository used to query order data for analytics
     */
<span class="fc" id="L44">    public AnalyticsService(OrderRepository orders) {</span>
<span class="fc" id="L45">        this.orders = orders;</span>
<span class="fc" id="L46">    }</span>

    /**
     * &lt;p&gt;
     * Computes the list of top-selling menu items by counting how many times
     * each item appears in completed orders. Completed orders include those
     * with status {@link OrderStatus#PAID} or {@link OrderStatus#SERVED}.
     * &lt;/p&gt;
     *
     * &lt;p&gt;
     * The result is returned as a map where each key is a menu item name and
     * the value is the number of times that item was ordered.
     * &lt;/p&gt;
     *
     * @param actor the staff role requesting analytics access
     * @return a map of item names to sales counts
     *
     * @throws SecurityException if the role is not authorized to view analytics
     */
    @Override
    public Map&lt;String, Long&gt; topSellingItems(StaffRole actor) {

<span class="fc" id="L68">        permissions.check(actor, &quot;view top-selling analytics&quot;);</span>

        // Consider only paid or served orders
<span class="fc" id="L71">        List&lt;Order&gt; completed = new ArrayList&lt;&gt;(orders.findByStatus(OrderStatus.PAID));</span>
<span class="fc" id="L72">        completed.addAll(orders.findByStatus(OrderStatus.SERVED));</span>

<span class="fc" id="L74">        return completed.stream()</span>
<span class="fc" id="L75">                .flatMap(o -&gt; o.getItems().stream())</span>
<span class="fc" id="L76">                .collect(Collectors.groupingBy(</span>
                        MenuItem::getName,     // group by item name
<span class="fc" id="L78">                        Collectors.counting()  // count how many times sold</span>
                ));
    }

    /**
     * &lt;p&gt;
     * Calculates total revenue generated from all paid orders created today.
     * Only orders with status {@link OrderStatus#PAID} are considered, and
     * only if their creation date matches the system's current date.
     * &lt;/p&gt;
     *
     * @param actor the staff role requesting analytics access
     * @return revenue total for today's paid orders, or {@code 0.0} if none exist
     *
     * @throws SecurityException if the role is not authorized to view revenue analytics
     */
    @Override
    public double totalRevenueToday(StaffRole actor) {

<span class="fc" id="L97">        permissions.check(actor, &quot;view revenue analytics&quot;);</span>

<span class="fc" id="L99">        LocalDate today = LocalDate.now();</span>

        // Filter only PAID orders for today's date
<span class="fc" id="L102">        return orders.findByStatus(OrderStatus.PAID).stream()</span>
<span class="fc" id="L103">                .filter(o -&gt; o.getCreatedAt().toLocalDate().equals(today))</span>
<span class="fc" id="L104">                .mapToDouble(Order::calculateTotal)</span>
<span class="fc" id="L105">                .sum();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>